<!doctype html>
<html>
<head>
    <title>Vorple</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" type="text/css" href="interpreter/roboto.css">
    <link rel="stylesheet" type="text/css" href="interpreter/jquery.powertip.css">
    <link rel="stylesheet" type="text/css" href="interpreter/toastr.css">
    <link rel="stylesheet" type="text/css" href="interpreter/vex.css">
    <link rel="stylesheet" type="text/css" href="interpreter/vex-theme-plain.css">

    <link rel="stylesheet" type="text/css" href="interpreter/haven.css">
    <link rel="stylesheet" type="text/css" href="interpreter/vorple.css">
</head>
<body>
<main id="vorple">
    <div id="loader">
        <h2 id="loader-message">Loading scripts</h2>
        <div id="spinner">V</div>
    </div>
</main>

<script src="interpreter/vorple.min.js"></script>
<script>
    if (location.protocol === "file:") {
      var interpolation = document.createElement('script');
      interpolation.setAttribute('src','demo.ulx.js');
      document.head.appendChild(interpolation);
    }
</script>



<style>
#container {
  width: 200px;
  height: 200px;
  position: relative;
}

.field {
  width: 50px;
  height: 50px;
  position: absolute;
  background: yellow;
  border-radius: 50%;
  padding: 6px;
}
</style>
<script>
	document.audioEnabled = 0;
    document.audioExt = 'mp3';
    var audio = new Audio();
    if (audio.canPlayType("audio/ogg") != "") {
      document.audioExt = 'ogg';
    }
    else {
      document.audioExt = 'mp3';
    }

    function IsPlayingMP3s() {
      if (document.audioExt == 'mp3') return 1;
      return 0;
    }

    function IsPlayingOGGs() {
      if (document.audioExt == 'ogg') return 1;
      return 0;
    }

    function ToggleAudioExtension() {
      if (document.audioExt == 'mp3') document.audioExt = 'ogg';
      else if (document.audioExt == 'ogg') document.audioExt = 'mp3';
      vorple.options.resource_paths.audio = audio_root+document.audioExt+"/";
    }

    function IsIpad() {
      if (navigator.userAgent.indexOf('iPad;') > 0) {
        return 1;
      }
      return 0;
    }

    function IsTTSSupported() {
      if ('speechSynthesis' in window) {
        return 1;
      }
      return 0;
    }

    function PlayNowAsList(str) {
	  if (document.audioEnabled == 0) return;
      var pn = vorple.options.resource_paths.audio+str+"."+document.audioExt;
      var pl = new Array();
      pl[0] = pn;
      pl[1] = '';
      pl.pop();
      vorple.audio.setPlaylist(pl,{looping: false, restart: true, shuffled: false});
    }
    function PlayNowAsEffect(str, loop) {
	  if (document.audioEnabled == 0) return;
      return vorple.audio.playSound(vorple.options.resource_paths.audio+str+"."+document.audioExt, {looping: loop});
    }
    function CancelTTS(str) {
      window.speechSynthesis.cancel();
      document.ttsOutput = "";
      document.ttsPunctuate = false;
    }
    function AddTTS(str, punctuate) {
	  if (document.audioEnabled == 0) return;
      document.ttsOutput += str + "  ";
      if (punctuate) {
        document.ttsPunctuate = true;
      }
    }
    function CancelBin(str) {
      document.binOutput = new Array();
    }
    function AddBin(str) {
	  if (document.audioEnabled == 0) return;
      if (document.binOutput.lastIndexOf(vorple.options.resource_paths.audio+str+"."+document.audioExt) >= 0) {
        if (document.binOutput[document.binOutput.length-1] == (vorple.options.resource_paths.audio+str+"."+document.audioExt));
        else {
          document.binOutput[document.binOutput.length] = vorple.options.resource_paths.audio+str+"."+document.audioExt;
        }
      }
      else
      document.binOutput[document.binOutput.length] = vorple.options.resource_paths.audio+str+"."+document.audioExt;
    }
    function FlushTTS() {
	  if (document.audioEnabled == 0) return;
      var u;
      window.speechSynthesis.speak(u = new SpeechSynthesisUtterance(document.ttsOutput));
      if (document.ttsPunctuate) {
        u.onend = function(event) {
          if (document.ttsPunctuate) {
            PlayNowAsEffect('se_pause',false);
            document.flushedTtsPunctuate = true;
            document.ttsPunctuate = false;
          }
          else {
            document.flushedTtsPunctuate = false;
          }
        }
      }
      document.flushedTtsOutput = document.ttsOutput;
      document.ttsOutput = "";
    }
    function FlushBin() {
	  if (document.audioEnabled == 0) return;
      var pl = new Array();
      for (j = 0; j < document.binOutput.length; j++) {
        pl[j] = document.binOutput[j];
      }
      pl[j] = '';
      pl.pop();
      vorple.audio.setPlaylist(pl,{looping: false, restart: true, shuffled: false});
      document.flushedBinOutput = document.binOutput;
      document.binOutput = new Array();
    }
    function FlushBinOrTTS() {
	  if (document.audioEnabled == 0) return;
      if (document.binOutput.length > 0) {
        FlushBin();
        document.ttsOutput = "";
      }
      else {
        FlushTTS();
      }
    }

    document.audioNarrationLength = 0;
    document.ttsOutput = "";
    document.ttsPunctuate = false;
    document.binOutput = new Array();
    document.flushedTtsOutput = "";
    document.flushedTtsPunctuate = false;
    document.flushedBinOutput = new Array();
    document.menuCommand = null;

    document.ambientAudioElementLoop1 = null;
	document.ambientAudioCallback1 = null;
    function clearAmbientAudioElementLoop1() {
      if (document.ambientAudioElementLoop1) {
        vorple.audio.fadeOut(document.ambientAudioElementLoop1,0)
      }
      document.ambientAudioElementLoop1 = null;
    }
    function restartAmbientAudioElementLoop1(f) {
      clearAmbientAudioElementLoop1();
      document.ambientAudioElementLoop1 = PlayNowAsEffect(f,true);
    }

    document.ambientAudioElementLoop2 = null;
	document.ambientAudioCallback2 = null;
    function clearAmbientAudioElementLoop2() {
	  if (document.ambientAudioCallback2) {
	  	clearTimeout(document.ambientAudioCallback2);
	  }
      if (document.ambientAudioElementLoop2) {
        vorple.audio.fadeOut(document.ambientAudioElementLoop2,0)
      }
      document.ambientAudioElementLoop2 = null;
	  document.ambientAudioCallback2 = null;
    }
    function restartAmbientAudioElementLoop2(f, delay) {
      clearAmbientAudioElementLoop2();
	  if (delay && delay > 0) {
	  	document.ambientAudioCallback2 = setTimeout(PlayNowAsEffect, delay, f, true);
	  }
	  else document.ambientAudioElementLoop2 = PlayNowAsEffect(f,true);
    }

    audio_root = "resources/audio/";
    vorple.debug.off();
	vorple.audio.defaults.fadeDuration = 25;
	vorple.audio.defaults.pauseBetweenTracks = 0;
    vorple.options = {
        autosave: false,
        engineColors: false,
        resource_paths: {
            images: "resources/images/",
            audio: audio_root+document.audioExt+"/"
        },

        // URL to the game file
        story: "demo.ulx"
    };

	actionMenuFlag = false;
	commonMenuFlag = false;
	complexMenuFlag = false;
	actionMenuItems = false;
	actionMenuArray = null;
	actionItemName = null;
	commonArray = null;
	complexArray = null;
	activeArray = null;

	function rotateCommandSelection() {
		ddbs = document.getElementById('ddbs');
		if (ddbs)
			if (ddbs.innerHTML == "0 - -") {
				ddbs.innerHTML = "- 0 -";
				document.ddbsStatus = ddbs.innerHTML;
				activeArray = complexArray;
			}
			else if (ddbs.innerHTML == "- 0 -") {
				ddbs.innerHTML = "- - 0";
				document.ddbsStatus = ddbs.innerHTML;
				activeArray = actionMenuArray;
			}
			else {
				ddbs.innerHTML = "0 - -";
				document.ddbsStatus = ddbs.innerHTML;
				activeArray = commonArray;
			}
		updateCommandAssistant('container');
	}

	function updateCommandAssistant(containerId) {
		el = document.getElementById("container");
		el.innerHTML = "";

		tmpArray = activeArray;
		verb = 'select ';
		if (tmpArray == complexArray) verb = 'selectc ';
		for (i = 0; i < tmpArray.length; i++) {
			style = 'display: flex; justify-content: center; align-items: center;';
			el.innerHTML += '<div class="field" style="' + style + '"><a onclick="document.getElementById(\'container\').style.display=\'none\'; vorple.prompt.queueCommand(\'' + verb + tmpArray[i] + '\');">' + tmpArray[i] + '</a></div>'
		}

		freshHTML = el.innerHTML;
		freshHTML += `
			<div id="container2" style="width: 100px; height: 50px; position: fixed; left: 50%; top: 50%; -webkit-transform: translate(-50%, -50%); transform: translate(-50%, -50%);">
			<div>
			  <button style="width:80px; height: 75px;" id='ddb' onclick='rotateCommandSelection();'>@AIN</button><br>
			  <button style="width:80px; height: 20px;" id='ddbs'>@STATUS</button><br>
			</div>
			</div>
		`;
		freshHTML  = freshHTML.replace("@AIN","common " + actionItemName + " commands");
		if (document.ddbsStatus) {
			freshHTML  = freshHTML.replace("@STATUS",document.ddbsStatus);
		}
		else {
			freshHTML  = freshHTML.replace("@STATUS","0 - -");
		}

		el.innerHTML = freshHTML;
		el.style.display = "";
		nodeList = container.querySelectorAll(".field");
	  	const getWidthHeight = element => {
		  const { width, height } = element.getBoundingClientRect();
		  return [width, height];
		};

		angle = 0;
		for (n = 0; n < nodeList.length; n++) {
			[w, h] = getWidthHeight(container);
			[w2, h2] = getWidthHeight(nodeList[n]);

			radius = (875) / 4;
			step = (2 * Math.PI) / 24;
			if (n < 8) {
				radius = 80;
				step = (2 * Math.PI) / 8;
			}
			else if (n < 24) {
				radius = 150;
				step = (2 * Math.PI) / 16;
			}

	      	const x = Math.round(w / 2 + radius * Math.cos(angle) - w2 / 2)-10;
	      	const y = Math.round(h / 2 + radius * Math.sin(angle) - h2 / 2)+25;

			nodeList[n].style.left = x+'px';
			nodeList[n].style.top = y+'px';
			angle += step;
		}

	}

	function actionMenuOutputFilter( output, meta ) {
		if (!actionMenuFlag) {
			if (output.indexOf("Common actions with ") == 0) {
				actionMenuItems = true;
				actionMenuFlag = true;
				commonMenuFlag = true;
				complexMenuFlag = false;
				actionMenuArray = new Array();
				commonArray = new Array();
				complexArray = new Array();
				activeArray = commonArray;
				actionItemName = output.substring(20, output.length-2);
				return "";
			}
		}
		else {
			if (output.indexOf("Other actions with ") >= 0) {
				actionMenuFlag = true;
				commonMenuFlag = false;
				complexMenuFlag = false;
				return "";
			}
			if (output.indexOf("Complex actions with ") >= 0) {
				actionMenuFlag = true;
				commonMenuFlag = false;
				complexMenuFlag = true;
				return "";
			}
			if (output.indexOf(".") >= 0) {
				actionMenuFlag = false;
				actionMenuItems = false;
				document.ddbsStatus = null;
				updateCommandAssistant('container');
			}
			if (actionMenuFlag && actionMenuItems)
				if (output != " \n" && output != " " && output != ": " && !(output.indexOf(".") >= 0)) {
					if (commonMenuFlag) {
						commonArray[commonArray.length] = output;
					}
					else if (complexMenuFlag) {
						complexArray[complexArray.length] = output;
					}
					else {
						actionMenuArray[actionMenuArray.length] = output;
					}
				}
			return "";
		}
	}
	vorple.output.addOutputFilter( actionMenuOutputFilter );

    function narratedOutputFilter( output, meta ) {
        if (document.audioNarrationLength == 0) {
          if (output != '\n') {
            var punctuate = false;
            var re = /([\S\s]*?)=(.*?);([\S\s]*)/;
            stop = false;
            while (!stop) {
              var ma = re.exec(output);
              if (ma) {
                output = ma[1] + ma[3];// + '\n';
                if (ma[2] == '!') {
                  punctuate = true;
                }
                else {
				  binlist = ma[2].split("|");
				  for (k = 0; k < binlist.length; k++) {
                  	AddBin(binlist[k]);
				  }
                }
              }
              else stop = true;
			}
            AddTTS(output, punctuate);
            return output;
          }
        }
    }
    vorple.output.addOutputFilter( narratedOutputFilter );

	//the first true prompt is never clickable, so apply hack here to fix this.
	function makeFirstPromptClickable( event ) {
		e = document.getElementById("lineinput-prefix");
		if (e.innerHTML == "&gt;") {
			vorple.removeEventListener(makeFirstPromptClickable);
			e.innerHTML = '<a onclick="vorple.prompt.queueCommand(document.menuCommand);">&gt;</a>';
		}
	}
	function initializeFirstPrompt() {
		vorple.addEventListener( [ "expectCommand", "expectKeypress" ], makeFirstPromptClickable );
	}

    function quitListener( event ) {
        clearAmbientAudioElementLoop1();
        clearAmbientAudioElementLoop2();

    }
    vorple.addEventListener( 'quit', quitListener );


vorple.init();
</script>
<div id="container" style="display: none; width: 550px; height: 550px; position: fixed; left: 50%; top: 50%; -webkit-transform: translate(-50%, -50%); transform: translate(-50%, -50%);">
</div>
<script>
function arrangeImagesInCircle(props = {}) {

  const getWidthHeight = element => {
    const { width, height } = element.getBoundingClientRect();
    return [width, height];
  };

  const container = document.getElementById("container");
  [containerWidth, containerHeight] = getWidthHeight(container);
  radius = props.radius || (containerWidth + containerHeight) / 4;

  return imageSelector => {
    const fields = container.querySelectorAll(imageSelector);
    const step = (2 * Math.PI) / fields.length;
    var angle = 0;
	index = 0;
    fields.forEach(field => {
	  index++;
	  if (index <= 4) {
	  containerWidth = 100;
	  containerHeight = 100;
	  radius = props.radius || (containerWidth + containerHeight) / 4;
	  }
	  else {
	  containerWidth = 200;
	  containerHeight = 200;
	  radius = props.radius || (containerWidth + containerHeight) / 4;
	  }

      const [fieldWidth, fieldHeight] = getWidthHeight(field);
      const x = Math.round(550 / 2 + radius * Math.cos(angle) - fieldWidth / 2);
      const y = Math.round(550 / 2 + radius * Math.sin(angle) - fieldHeight / 2);
      if (window.console) console.log(x, y);
      field.style.left = x + 'px';
      field.style.top = y + 'px';
      angle += step;
    });
  }

}

function selectCommandGroup(e) {
	el = document.getElementById('ddb');
	el.innerHTML = e.innerHTML;
}

</script>

<style>
/* Style The Dropdown Button */
.dropbtn {
  background-color: #4CAF50;
  color: white;
  padding: 4px;
  font-size: 16px;
  border: none;
  cursor: pointer;
}

/* The container <div> - needed to position the dropdown content */
.dropdown {
  position: relative;
  display: inline-block;
}

/* Dropdown Content (Hidden by Default) */
.dropdown-content {
  display: none;
  position: absolute;
  background-color: #f9f9f9;
  min-width: 160px;
  box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
  z-index: 1;
}

/* Links inside the dropdown */
.dropdown-content a {
  color: black;
  padding: 12px 16px;
  text-decoration: none;
  display: block;
}

/* Change color of dropdown links on hover */
.dropdown-content a:hover {background-color: #f1f1f1}

/* Show the dropdown menu on hover */
.dropdown:hover .dropdown-content {
  display: block;
}

/* Change the background color of the dropdown button when the dropdown content is shown */
.dropdown:hover .dropbtn {
  background-color: #3e8e41;
}
</style>
</body>
</html>
